name: Security Check

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: API Key & Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comprehensive scan

      - name: Detect hardcoded API keys in tracked files
        run: |
          echo "üîç Scanning for Gemini API keys in tracked files..."

          # Check for Gemini API key pattern (AIza followed by 35 chars)
          if git ls-files | xargs grep -l "AIza[A-Za-z0-9_-]\{35\}" 2>/dev/null; then
            echo "‚ùå ERROR: Gemini API key detected in tracked files!"
            echo "Files containing API keys:"
            git ls-files | xargs grep -n "AIza[A-Za-z0-9_-]\{35\}"
            exit 1
          fi

          echo "‚úÖ No API keys found in tracked files"

      - name: Verify sensitive files are not tracked
        run: |
          echo "üîç Checking for sensitive files in git..."

          SENSITIVE_FILES=(
            "local.properties"
            "functions/.env"
            "functions/.env.local"
            ".env"
            "google-services.json"
            "service-account.json"
            "firebase-admin-key.json"
          )

          FOUND_SENSITIVE=0
          for file in "${SENSITIVE_FILES[@]}"; do
            if git ls-files | grep -q "^${file}$"; then
              echo "‚ùå ERROR: Sensitive file tracked: $file"
              FOUND_SENSITIVE=1
            fi
          done

          if [ $FOUND_SENSITIVE -eq 1 ]; then
            echo ""
            echo "These files should be in .gitignore!"
            exit 1
          fi

          echo "‚úÖ No sensitive files are tracked"

      - name: Check for hardcoded secrets in code
        run: |
          echo "üîç Scanning for hardcoded secrets patterns..."

          # Patterns to search for
          PATTERNS=(
            'apiKey\s*=\s*["\x27]AIza'
            'GEMINI_API_KEY\s*=\s*["\x27]AIza'
            'api_key\s*=\s*["\x27]AIza'
            'functions\.config\(\)\.gemini\.key'
          )

          FOUND_SECRETS=0
          for pattern in "${PATTERNS[@]}"; do
            if git grep -E "$pattern" -- '*.kt' '*.java' '*.js' '*.ts' '*.json' '*.xml' 2>/dev/null; then
              echo "‚ùå Found potential hardcoded secret with pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done

          if [ $FOUND_SECRETS -eq 1 ]; then
            echo ""
            echo "Hardcoded secrets detected in source code!"
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets detected in source code"

      - name: Validate .gitignore coverage
        run: |
          echo "üîç Validating .gitignore has sensitive patterns..."

          REQUIRED_PATTERNS=(
            "local.properties"
            "*.env"
            "google-services.json"
            "service-account.json"
          )

          MISSING_PATTERNS=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "‚ö†Ô∏è  WARNING: .gitignore missing pattern: $pattern"
              MISSING_PATTERNS=1
            fi
          done

          if [ $MISSING_PATTERNS -eq 1 ]; then
            echo ""
            echo "Please update .gitignore with missing patterns"
            exit 1
          fi

          echo "‚úÖ .gitignore has all required patterns"

      - name: Check for API keys in commit messages
        run: |
          echo "üîç Scanning recent commit messages for API keys..."

          if git log --all --oneline -50 | grep -i "AIza[A-Za-z0-9_-]\{35\}"; then
            echo "‚ùå ERROR: API key found in commit messages!"
            echo "You may need to rewrite git history to remove this"
            exit 1
          fi

          echo "‚úÖ No API keys in recent commit messages"

      - name: Security scan summary
        if: success()
        run: |
          echo "‚úÖ ============================================"
          echo "‚úÖ  All security checks passed!"
          echo "‚úÖ ============================================"
          echo ""
          echo "Checks performed:"
          echo "  ‚úÖ No API keys in tracked files"
          echo "  ‚úÖ No sensitive files tracked"
          echo "  ‚úÖ No hardcoded secrets in code"
          echo "  ‚úÖ .gitignore properly configured"
          echo "  ‚úÖ No secrets in commit messages"
