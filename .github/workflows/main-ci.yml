name: SSBMax CI

on:
  push:
    branches: [ main, develop, feature/*, feature/**, tech-debt/**, PsyTests ]
  pull_request:
    branches: [ main, develop ]

env:
  # Enable Gradle Build Cache and parallel builds for maximum speed
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.jvmargs=-Xmx4g"

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: API Key & Secret Detection (Files)
        run: |
          echo "ðŸ” Scanning for Gemini API keys in tracked files..."
          if git ls-files | xargs grep -l "AIza[A-Za-z0-9_-]\{35\}" 2>/dev/null; then
            echo "âŒ ERROR: Gemini API key detected in tracked files!"
            exit 1
          fi

      - name: Verify sensitive files are not tracked
        run: |
          echo "ðŸ” Checking for sensitive files in git..."
          SENSITIVE_FILES=("local.properties" "functions/.env" "functions/.env.local" ".env" "google-services.json" "service-account.json" "firebase-admin-key.json")
          FOUND_SENSITIVE=0
          for file in "${SENSITIVE_FILES[@]}"; do
            if git ls-files | grep -q "^${file}$"; then
              echo "âŒ ERROR: Sensitive file tracked: $file"
              FOUND_SENSITIVE=1
            fi
          done
          [ $FOUND_SENSITIVE -eq 1 ] && exit 1 || echo "âœ… No sensitive files tracked"

      - name: Check for hardcoded secrets in code
        run: |
          echo "ðŸ” Scanning for hardcoded secrets patterns..."
          PATTERNS=('apiKey\s*=\s*["\x27]AIza' 'GEMINI_API_KEY\s*=\s*["\x27]AIza' 'api_key\s*=\s*["\x27]AIza' 'functions\.config\(\)\.gemini\.key')
          FOUND_SECRETS=0
          for pattern in "${PATTERNS[@]}"; do
            if git grep -E "$pattern" -- '*.kt' '*.java' '*.js' '*.ts' '*.json' '*.xml' 2>/dev/null; then
              echo "âŒ Found potential hardcoded secret: $pattern"
              FOUND_SECRETS=1
            fi
          done
          [ $FOUND_SECRETS -eq 1 ] && exit 1 || echo "âœ… No hardcoded secrets detected"

      - name: Validate .gitignore coverage
        run: |
          echo "ðŸ” Validating .gitignore..."
          REQUIRED=("local.properties" "*.env" "google-services.json" "service-account.json")
          for pattern in "${REQUIRED[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "âš ï¸  WARNING: .gitignore missing pattern: $pattern"
              exit 1
            fi
          done

      - name: Check for API keys in commit messages
        run: |
          echo "ðŸ” Scanning commit messages for secrets..."
          if git log --all --oneline -50 | grep -i "AIza[A-Za-z0-9_-]\{35\}"; then
            echo "âŒ ERROR: API key found in commit messages!"
            exit 1
          fi
          echo "âœ… Security checks passed"

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: security-scan
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY || 'test_key' }}" >> local.properties

      - name: Setup google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        if: ${{ env.GOOGLE_SERVICES_JSON != '' }}
        run: |
          echo "${GOOGLE_SERVICES_JSON}" > app/google-services.json

      # Run ALL tasks in a SINGLE Gradle invocation for maximum efficiency
      # This reuses the daemon, caches, and compiled code across all tasks
      - name: Build, Lint, and Test (All in One)
        run: |
          ./gradlew \
            :app:lintDebug \
            :app:testDebugUnitTest \
            :app:assembleDebug \
            -Dlint.baselines.continue=true \
            --build-cache \
            --parallel
        timeout-minutes: 20

      - name: Upload Artifacts (APK & Reports)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            app/build/outputs/apk/debug/*.apk
            **/build/reports/lint-results-*.html
            **/build/reports/tests/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "Build and Test completed. Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
