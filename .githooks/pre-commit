#!/bin/bash
# Pre-commit hook to prevent committing API keys and sensitive data
# This hook is triggered before each commit to validate security

set -e

echo "üîí Running pre-commit security checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# ============================================
# 1. Check for Gemini API keys in staged files
# ============================================
echo ""
echo "üîç Checking for API keys in staged files..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
    # Check for Gemini API key pattern (AIza followed by 35 chars)
    if echo "$STAGED_FILES" | xargs grep -l "AIza[A-Za-z0-9_-]\{35\}" 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: Gemini API key detected in staged files!${NC}"
        echo ""
        echo "Files with API keys:"
        echo "$STAGED_FILES" | xargs grep -n "AIza[A-Za-z0-9_-]\{35\}" 2>/dev/null
        echo ""
        echo "Remove the API key before committing."
        ERRORS=$((ERRORS + 1))
    fi
fi

# ============================================
# 2. Check for sensitive files being added
# ============================================
echo "üîç Checking for sensitive files..."

SENSITIVE_FILES=(
    "local.properties"
    "functions/.env"
    "functions/.env.local"
    ".env"
    "google-services.json"
    "app/google-services.json"
    "service-account.json"
    "firebase-admin-key.json"
)

for file in "${SENSITIVE_FILES[@]}"; do
    if echo "$STAGED_FILES" | grep -q "^${file}$"; then
        echo -e "${RED}‚ùå ERROR: Attempting to commit sensitive file: $file${NC}"
        echo "This file should be in .gitignore!"
        ERRORS=$((ERRORS + 1))
    fi
done

# ============================================
# 3. Check for hardcoded secrets in Kotlin/Java code
# ============================================
echo "üîç Scanning code for hardcoded secrets..."

KOTLIN_JAVA_FILES=$(echo "$STAGED_FILES" | grep -E '\.(kt|java)$' || true)

if [ -n "$KOTLIN_JAVA_FILES" ]; then
    # Pattern 1: apiKey = "AIza..."
    if echo "$KOTLIN_JAVA_FILES" | xargs grep -E 'apiKey\s*=\s*["\x27]AIza' 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: Hardcoded API key in Kotlin/Java code${NC}"
        ERRORS=$((ERRORS + 1))
    fi

    # Pattern 2: GEMINI_API_KEY = "AIza..."
    if echo "$KOTLIN_JAVA_FILES" | xargs grep -E 'GEMINI_API_KEY\s*=\s*["\x27]AIza' 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: Hardcoded GEMINI_API_KEY in code${NC}"
        ERRORS=$((ERRORS + 1))
    fi

    # Pattern 3: Deprecated functions.config() usage
    if echo "$KOTLIN_JAVA_FILES" | xargs grep -E 'functions\.config\(\)\.gemini' 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Using deprecated functions.config()${NC}"
        echo "Consider migrating to .env approach"
    fi
fi

# ============================================
# 4. Check for secrets in JavaScript/TypeScript (Firebase Functions)
# ============================================
JS_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts)$' | grep -v 'node_modules' || true)

if [ -n "$JS_TS_FILES" ]; then
    # Check for hardcoded API keys in functions
    if echo "$JS_TS_FILES" | xargs grep -E 'apiKey\s*=\s*["\x27]AIza' 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: Hardcoded API key in JavaScript/TypeScript${NC}"
        ERRORS=$((ERRORS + 1))
    fi

    # Ensure using process.env.GEMINI_API_KEY, not hardcoded value
    if echo "$JS_TS_FILES" | xargs grep -E 'GEMINI_API_KEY\s*=\s*["\x27]AIza' 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: Hardcoded GEMINI_API_KEY in functions code${NC}"
        ERRORS=$((ERRORS + 1))
    fi
fi

# ============================================
# 5. Check for secrets in XML/JSON config files
# ============================================
CONFIG_FILES=$(echo "$STAGED_FILES" | grep -E '\.(xml|json)$' | grep -v 'node_modules' || true)

if [ -n "$CONFIG_FILES" ]; then
    if echo "$CONFIG_FILES" | xargs grep -i "AIza[A-Za-z0-9_-]\{35\}" 2>/dev/null; then
        echo -e "${RED}‚ùå ERROR: API key found in config files${NC}"
        ERRORS=$((ERRORS + 1))
    fi
fi

# ============================================
# 6. Check for *Holder.kt anti-pattern files
# ============================================
echo "üîç Checking for anti-pattern files..."

HOLDER_FILES=$(echo "$STAGED_FILES" | grep -E 'Holder\.kt$' || true)

if [ -n "$HOLDER_FILES" ]; then
    echo -e "${RED}‚ùå ERROR: *Holder.kt files are forbidden (anti-pattern)${NC}"
    echo "Found: $HOLDER_FILES"
    echo ""
    echo "Use ViewModel for UI state or Repository for data management."
    ERRORS=$((ERRORS + 1))
fi

# ============================================
# 7. Validate commit message doesn't contain secrets
# ============================================
echo "üîç Checking commit message (if available)..."

# Note: Commit message is not yet available in pre-commit hook
# This check is done in commit-msg hook instead

# ============================================
# Final result
# ============================================
echo ""

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}============================================${NC}"
    echo -e "${RED}‚ùå  Pre-commit checks FAILED with $ERRORS error(s)${NC}"
    echo -e "${RED}============================================${NC}"
    echo ""
    echo "Fix the issues above before committing."
    echo ""
    echo "To bypass this hook (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}============================================${NC}"
    echo -e "${GREEN}‚úÖ  All pre-commit checks passed!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo ""
    exit 0
fi
